#!/bin/bash
set -e # Exit on any child process error

# Handle making sure an exact version number is installed while building the docker container
echo "Updating dockerfile to reference specific version from npm"
VERSION_NUMBER=$(node -p "require('./package.json').version")
sed -i -e "s|##VERSION_NUMBER##|$VERSION_NUMBER|g" Dockerfile
echo "Installing awsudo@$VERSION_NUMBER"

echo "Deploying: awsudo/awsudo:${DOCKER_TAG}"

echo "Logging in"
docker login -u ${DOCKER_USERNAME} -p "${DOCKER_PASSWORD}"
echo "Building..."
docker build . -t awsudo/awsudo:latest -t awsudo/awsudo:${DOCKER_TAG}
echo "Push awsudo/awsudo:latest"
docker push awsudo/awsudo:latest
echo "Push awsudo/awsudo:${DOCKER_TAG}"
docker push awsudo/awsudo:${DOCKER_TAG}
echo "All done!"